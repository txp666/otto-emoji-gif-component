name: Publish to ESP Component Registry

on:
  push:
    tags:
      - 'v*'  # Trigger when pushing version tags (e.g., v1.0.3)
  release:
    types: [published]  # Trigger when creating Release

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Need write permission to create Release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify idf_component.yml
        run: |
          echo "Checking idf_component.yml file..."
          if [ ! -f "idf_component.yml" ]; then
            echo "Error: idf_component.yml file not found"
            exit 1
          fi
          echo "idf_component.yml file exists"
          cat idf_component.yml

      - name: Extract version
        id: get_version
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION=${GITHUB_EVENT_RELEASE_TAG_NAME#v}
          elif [ -n "${{ github.ref }}" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep '^version:' idf_component.yml | awk '{print $2}' | tr -d '"' | tr -d "'")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create Release if not exists
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          
          # Check if Release already exists
          if curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/txp666/otto-emoji-gif-component/releases/tags/$TAG_NAME" | grep -q '"id"'; then
            echo "Release $TAG_NAME already exists, skipping creation"
          else
            echo "Creating Release $TAG_NAME..."
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json; charset=utf-8" \
              "https://api.github.com/repos/txp666/otto-emoji-gif-component/releases" \
              -d "{
                \"tag_name\": \"$TAG_NAME\",
                \"name\": \"$TAG_NAME\",
                \"body\": \"$TAG_NAME\\n\\nComponent will be automatically synced to ESP Component Registry.\\n\\nView component: https://components.espressif.com/components/txp666/otto-emoji-gif-component\",
                \"draft\": false,
                \"prerelease\": false
              }"
          fi

      - name: Trigger ESP Registry Sync
        env:
          IDF_COMPONENT_API_TOKEN: ${{ secrets.IDF_COMPONENT_API_TOKEN }}
        run: |
          echo "Triggering ESP Component Registry sync..."
          
          if [ -n "$IDF_COMPONENT_API_TOKEN" ]; then
            echo "Using API Token for sync..."
            # Try to trigger sync via API if token is available
            curl -X POST \
              -H "Authorization: Bearer $IDF_COMPONENT_API_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.components.espressif.com/v1/webhooks/github" \
              -d "{\"repository\": \"txp666/otto-emoji-gif-component\", \"tag\": \"${{ github.ref_name }}\"}" \
              || echo "API call failed, will sync via automatic scan"
          else
            echo "IDF_COMPONENT_API_TOKEN not set"
            echo "Component will be synced via ESP Component Registry automatic scan (may take minutes to hours)"
            echo "Get Token: https://components.espressif.com/ -> Settings -> Tokens"
          fi

      - name: Summary
        run: |
          echo "## Component Release Info" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: https://github.com/txp666/otto-emoji-gif-component" >> $GITHUB_STEP_SUMMARY
          echo "- **Component Link**: https://components.espressif.com/components/txp666/otto-emoji-gif-component" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Component will be automatically synced to ESP Component Registry." >> $GITHUB_STEP_SUMMARY

